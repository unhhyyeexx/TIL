# Process & Thread

[toc]



## Process

**프로세스는 운영체제로부터 자원을 할당받은 작업의 단위**

### 프로그램과 프로세스

- **(정적) 프로그램 (Static Program)**

  - 컴퓨터에서 실행할 수 있는 파일 통칭.
  - 단, 아직 실행하지 않은 상태 => 정적 프로그램 => 줄여서 프로그램
  - 쉽게 말해, 코드 덩어리
- **프로세스**

  - 프로그램을 실행 시켜 정적인 프로그램이 동적으로 변해 **프로그램이 돌아가고 있는 상태**
  - 즉, 컴퓨터에서 작업 중인 프로그램을 의미
  - 모든 프로그램은 운영체제가 실행되기 위한 메모리 공간을 할당해 줘야 실행될 수 있다. 그래서 프로그램을 실행하는 순간 파일은 컴퓨터 메모리에 올라가게 되고, 운영체제로부터 시스템 자원(CPU)를 할당받아 프로그램 코드를 실행시켜 서비스를 이용할 수 있게 된다.
> 정리하면, **프로그램은 파일이 저장장치에 있지만 메모리에는 올라가있지 않은 정적인 상태**이고, 
>
> **프로세스는 메모리에 적재되고 CPU 자원을 할당받아 프로그램이 실행되고 있는 상태**를 말한다.

### 프로세스 동작

- 운영체제가 **여러 개의 프로세스(멀티 프로세스)**를 함께 돌리고 있다.
- **동시적/병렬적/혼합**의 방법을 이용한다.
  - 동시성: CPU에 코어 하나, CPU에서 여러 프로세스를 돌면서 일부분을 연속적으로 실행 시키는 것(context switching)
  - 병렬성: CPU에 코어 여러개, 여러 프로그램을 병렬적으로 실행

- 운영체제는 **프로세스마다 자원을 분할**해 할당한다.

### Multi Process

**하나의 프로그램을 여러개의 프로세스**로 구성하여 각 프로세스가 하나의 작업(task)를 처리하는 것

- 장점 : 하나의 프로세스가 잘못 되어도 프로그램은 동작 한다.
- 단점 : context switching 비용이 발생





## Thread

**프로세스가 할당 받은 자원을 이용하는 실행 흐름의 단위**

### 스레드의 개념

- 프로세스 내에서 동시에 진행되는 작업 갈래, 흐름의 단위

  - 크롬 브라우저가 실행되면 프로세스 하나가 생성될 것이다. 우리는 브라우저에서 파일을 다운받으며 온라인 쇼핑을 하면서 게임을 하기도 한다.
  - 즉, 하나의 프로세스 안에서 여러가지 작업의 흐름이 동시에 진행되기 때문에 가능,
  - 이러한 일련의 작업 흐름들을 스레드라고 한다.
- 기본적으로 프로세스마다 최소 1개의 스레드를 소유한다(메인 스레드 포함)
- 프로세스는 스레드를 여러 개 생성해 여러 작업을 동시에 처리할 수 있다.

![스레드](Process%20&%20Thread.assets/IwE9m.png)

- 하나의 프로세스 안에 여러개의 스레드들이 들어있을 수 있고, 스레드 수가 많을 수록 당연히 프로그램 속도도 동시에 하는 작업이 많아져 성능이 올라간다.

- 일반적으고 하나의 프로그램은 하나 이상의 프로세스를 가지고 있고, 하나의 프로세스는 하나 이상의 스레드를 갖는다. 

- 즉, 프로세스를 생성하면 기본적으로 하나의 main 스레드가 생성되고, 메인 이외의 스레드는 그 이상 생길 수 있다. 그 이외의 스레드는 개발자가 직접 프로그래밍하여 위치시킨다.

- 스레드들은 프로세스마다 **정해진 자원을 함께 사용**한다 

  ->스레드들은 **부모 프로세스**의 자원을 공유하여 **영향**을 받아 **데이터 공유**가 가능

  -> 여러 스레드가 **공통된 자원에 접근**하여 조작할 경우 **에러**가 발생





## Process와 Thread의 메모리

### 프로세스의 자원 구조

![process memory](Process%20&%20Thread.assets/HvlGH1o.png)

- **코드 영역(Code / Text)** : 개발자가 작성한 프로그램 함수들의 코드가 CPU가 해석가능한 기계어 형태로 저장
- **데이터 영역(Data)** : 코드가 실행되면서 사용하는 전역변수나 각종 데이터들이 모여있음.
- 스택 영역(Stack) :  지역변수와 같은 호출한 함수가 종료되면 되돌아올 임시적인 자료를 저장하는 독립적인 공간.
- 힙 영역(Heap) : 생성자, 인스턴스와 같은 동적으로 할당되는 데이터들을 위해 존재하는 공간. 사용자에 의해 메모리 공간이 동적으로 할당되고 해제된다.
- Stack과 Heap 영역은 프로세스가 실행되는 동안 크기가 늘어났다 줄어들기도 하는 동적 영역.

![process operation](Process%20&%20Thread.assets/img.gif)

- 위 그림은 프로그램이 여러개 실생될 때 메모리에 프로세스들이 담길 주소 공간이 생성되는 모습





### 스레드의 자원 공유

![thread in process](Process%20&%20Thread.assets/039Jqwl1DcgCaTEGr.png)

- 파일을 다운 받으며 동시에 웹서핑을 할 수 있다. 이는 스레드가 여러개이기 때문에 가능

  => **스레드끼리 프로세스의 자원을 공유**하며 프로세스 실행 흐름의 일부가 되기 때문에 **동시 작업**이 가능

![Shared Resources](Process%20&%20Thread.assets/multi-thread.png)

- 스레드는 프로세스 내에서 각 Stack만 따로 할당받아 복사하고, Code, Data, Heap 영역은 프로세스 내 다른 스레드들과 공유한다.
  - Stack영역만 따로 할당받는 이유?
    - stack은 함수 호출 시 전달되는 인자, 되돌아갈 주소값, 함수 내에서 선언하는 변수 등을 저장하는 메모리 공간
    - 즉, 독립적인 스택 == 독립적인 함수 호출 가능
    - 독립적인 함수 호출 가능 == 독립적인 실행 흐름이 추가됨
    - 그렇기에, stcak을 가짐으로써 스레드는 독립적인 실행 흐름을 가질 수 있게 된다.
- 각각의 스레드는 별도의 stack을 가지고 있지만, heap메모리는 고유하기 때문에 서로 다른 스레드에서 가져와 읽고 쓸 수 있게 된다. 다른 프로세스의 메모리에는 접근 불가능.
- 자원 공유가 가능한 이유는, 하나의 프로세스를 다수의 실행 단위인 스레드로 구분하여 자원을 공유하고, 자원의 생성과 관리의 중복성을 최소화하여 수행 능력을 올리기 위해서임.

#### 프로세스의 자원공유?

>  기본적으로 각 프로세스는 메모리에 별도의 주소공간에서 실행 => 한 프로세스는 다른 프로세스에 접근 불가능
>
> 과연 아예 접근 불가능일까??

- IPC사용, LPC사용, 별도의 공유 메모리를 만들어서 정보를 주고 받도록 설정하는 등의 방법으로 프로세스 간 정보를 공유할 수 있긴 하다.

- 그러나 단지 CPU 레지스터 교체뿐 아니라 RAM과 CPU사이의 캐시 메모리까지 초기화되는 등의 **자원 부담이 크다**는 크리티컬한 단점 때문에 다중 작업이 필요한 경우 **스레드를 이용하는 것이 훨씬 효율적**이다.

- 운영체제 대부분이 다중 프로세싱을 지원하긴 하지만, 다중 스레딩을 기본으로 하는 이유.

#### 멀티 프로세스, 멀티 스레드

그러나, 멀티 프로세스가 단점만 있는 것은 아니다. 장점은 다음과 같다.
1. 하나의 프로세스가 죽더라도 다른 프로세스에 영향을 주지 않아 안정성이 높고,
2. 여러개의 프로세스가 처리되어야 할 때 동일한 데이터를 사용하는데, 이러한 데이터를 하나의 디스크에 두고 모든 프로세서(CPU)가 이를 공유하면 비용적으로 저렴하다.

이를 반대로 하면 멀티 스레드의 단점이 된다.

1. 하나의 스레드 장애로 전체 스레드(프로세스)가 종료될 위험이 있다.
2. 스레드 간의 자원을 공유해 전역 변수를 사용하기에 동기화 문제(병목현상, 데드락) 가 발생할 수 있다.
3. 주의깊은 설계가 필요하고 디버깅이 어렵다.






## Single Threading, Multi Threading

> 일련의 처리를 단일 스레드만으로 직렬로 처리하는 방식 : 싱글 스레딩
>
> 동일 주소 공간의 메모리를 공유하며 병렬로 처리하는 방식 : 멀티 스레딩

### 싱글 스레드

하나의 프로세스에서 하나의 스레드(메인 스레드)만 실행시킨다.

- 장점

  - 공유 자원을 접근하는 동기화 문제를 신경쓰지 않아도 됨

    ![](Process%20&%20Thread.assets/scode=mtistory2&fname=https%253A%252F%252Fblog.kakaocdn.net%252Fdn%252FO3NN4%252FbtrpRYjQUpY%252FM7NCJLkbiP1NDdihuzdsQK%252Fimg.png)

    - 여러 개의 쓰레드가 같은 데이터에 접근하는 경우, 경우에 따라 동시성 문제가 발생할 수 있다.
    - 여러개의 스레드가 공유된 자원에 접근 할 때 데이터의 신뢰성을 보장받을 수 없어 동기화 작업이 필요하다.

  - context switch 작업을 요구하지 않아, 전환 비용이 들지 않음

- 단점

  - 여러개의 CPU 활용을 못한다.

### 멀티 스레드

하나의 프로세스에서 다수의 스레드를 실행시킨다.

- 장점
  - 새로운 프로세스를 생성하는 것보다 기존 프로세스에서 스레드를 생성하는 것이 더 빠르다.
  - 프로세스의 자원과 상태를 공유해 효율적인 운영이 가능하다.
- 단점
  - 하나의 스레드만 실행중일때는 실행시간이 오히려 지연될 수 있다.
  - 멀티 스레딩을 위해 운영체제의 지원이 필요하다
  - 스레드 스케줄링을 신경써야 한다.

### 어느 상황에서 싱글스레딩? 멀티스레딩?

- 장단점만 보면 멀티 스레딩이 더 효율적으로 보일 수 있다.

  두 개의 작업을 하나의 스레드로 처리하는 경우와, 두 개의 스레드로 처리하는 경우를 가정해보자.

  후자의 경우는 짧은 시간 동안 2개의 스레드가 번갈아가면서 작업을 수행한다. 그래서 동시에 두 작업이 처리되는 것과 같이 느끼게 된다.

  두 개의 스레드로 작업한 시간이 싱글 스레드로 작업한 시간보다 더 걸릴 수 있다. 이유는 스레드 간의 작업전환(context switching)에 시간이 걸리기 때문

  따라서 단순히 CPU만을 사용하는 계산작업이라면, 오히려 멀티스레딩보다 싱글스레딩 방식으로 프로그래밍 하는 것이 더 효율적일 수 있다.





## 자바스크립트는 왜 싱글스레드를 채택했을까

> 위에서 본 바로는 싱글스레드는 한 번에 하나의 작업만 수행할 수 있다. 
>
> 그렇다면 자바스크립트를 주로 사용하는 웹 사이트에서는 어떻게 한번에 여러개의 요청을 처리할 수 있을까? 
>
> 그리고 여러 요청이 오갈 수 있는 자바스크립트는 왜 싱글스레드일까?

#### JS는 정말로 싱글 스레드인가?

- Yes. 정확하게는 자바스크립트의 메인 스레드인 이벤트 루프가 싱글스레드이기 때문에 싱글스레드 언어라고 부른다.

- 하지만 이벤트 루프만 독립적으로 실행되지 않고 웹 브라우저나 NodeJS 같은 멀티 스레드 환경에서 실행된다.
- 즉, **JS 자체는 싱글 스레드가 맞지만, JS 런타임은 싱글 스레드가 아니다**.
#### 싱글 스레드로 여러 요청 처리도 가능?
가능하다. 하나의 요청이 완료될 때까지 기다리지 않고 동시에 다른 작업을 실행하는 **비동기 작업**을 통해 여러 요들을 처리할 수 있다.

Web API, Callback Queue, Event Loop덕분에 멀티스레드처럼 동시성을 지닌다.

### 왜 싱글스레드일까..?

왜 싱글스레드를 쓸까? 멀티스레드를 쓰면 편하지 않을까?

이유는 **'쉬워서'** 이다..!!!

자바스크립트가 멀티스레드로 실행되는 언어였다면 웹페이지에서 발생하는 동시성 문제에 대해 해결해야 했고, 실제로 멀티스레드로 구현된 서비스에서는 이 동시성 문제에 대해 많은 노력을 한다.

하지만 자바스크립트는 단일 스레드로 실행되므로 다중 스레드에서 발생할 수 있는 교착 상태와 같은 복잡한 시나리오를 신경쓸 필요가 없으며 비동기 처리를 통해 쉽게 여러 요청을 처리할 수 있다.

실제로 구글의 Chrome 브라우저 마저도 기존 웹 페이지에서 엄청난 동시성 문제를 일으킬 수 있다는 이유로 단일 웹사이트 페이지의 자바스크립트 코드가 동시에 실행되는 것을 허용하지 않는다.









# Reference

[운영체제와 프로세스 스레드](https://velog.io/@yooon26/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C%EC%99%80-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%EC%8A%A4%EB%A0%88%EB%93%9C)

[프로세스&스레드](https://github.com/gyoogle/tech-interview-for-developer/blob/master/Computer%20Science/Operating%20System/Process%20vs%20Thread.md)

[프로세스와 스레드 차이](https://inpa.tistory.com/entry/%F0%9F%91%A9%E2%80%8D%F0%9F%92%BB-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%E2%9A%94%EF%B8%8F-%EC%93%B0%EB%A0%88%EB%93%9C-%EC%B0%A8%EC%9D%B4)

[멀테프로세스vs멀티스레드 비교](https://inpa.tistory.com/entry/%F0%9F%91%A9%E2%80%8D%F0%9F%92%BB-multi-process-multi-thread)

[자바스크립트는 왜 싱글 스레드를 선택했을까?](https://miracleground.tistory.com/entry/%EC%9E%90%EB%B0%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8%EB%8A%94-%EC%99%9C-%EC%8B%B1%EA%B8%80-%EC%8A%A4%EB%A0%88%EB%93%9C%EB%A5%BC-%EC%84%A0%ED%83%9D%ED%96%88%EC%9D%84%EA%B9%8C-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4-%EC%8A%A4%EB%A0%88%EB%93%9C-%EB%B9%84%EB%8F%99%EA%B8%B0-%EB%8F%99%EA%B8%B0-%EC%9E%90%EB%B0%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%EC%97%94%EC%A7%84-%EC%9D%B4%EB%B2%A4%ED%8A%B8%EB%A3%A8%ED%94%84)

[자바스크립트는 왜 싱글 쓰레드일까?](https://chanyeong.com/blog/post/44)

[[[OS\] 프로그램 VS 프로세스 VS 스레드](https://zangzangs.tistory.com/109)]

